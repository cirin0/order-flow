<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="h-full">
<head th:replace="~{fragments/head :: head}"></head>
<body class="bg-gray-100 flex flex-col h-full m-0"> <!-- Світлий фон для body -->
<header th:replace="~{fragments/header :: header}"></header>

<div class="page-wrapper">
  <div class="background-wrapper">
    <div class="cityscape"></div>
    <div class="cityscape-revers"></div>
    <div class="smoke-effect"></div>
  </div>

  <main class="content mt-5 flex-grow">
    <div class="order-create-page">
      <h1>Створення замовлення</h1>

      <div th:if="${cart.items.isEmpty()}" class="cart-empty">
        <p>Твій кошик пустий</p>
        <a href="/cart" class="btn-back">Повернутися до кошика</a>
      </div>

      <div th:unless="${cart.items.isEmpty()}" class="cart-items">
        <table class="cart-items-table">
          <thead>
          <tr>
            <th>Товар</th>
            <th class="text-center">Кількість</th>
            <th class="text-right">Ціна</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="item : ${cart.items}">
            <td th:text="${item.productName}">Назва товару</td>
            <td class="text-center" th:text="${item.quantity}">Кількість</td>
            <td class="text-right" th:text="${#numbers.formatDecimal(item.price, 1, 2)}">Ціна</td>
          </tr>
          </tbody>
        </table>

        <p class="cart-total">Загальна сума: <span
          th:text="${#numbers.formatDecimal(cart.totalPrice, 1, 2)}">Сума</span></p>

        <form th:action="@{/orders/create}" method="post" class="form-section">
          <!-- Контактна інформація -->
          <div class="form-section">
            <h2>Контактна інформація</h2>
            <div class="form-group">
              <label for="fullName">ПІБ:</label>
              <input type="text"
                     id="fullName"
                     name="fullName"
                     th:value="${userDetails != null ? userDetails.firstName + ' ' + userDetails.lastName : ''}"
                     required
                     pattern="[А-Яа-яІіЇїЄєҐґ'\s]+"
                     title="Введіть коректне ПІБ">
            </div>

            <div class="form-group">
              <label for="phone">Номер телефону:</label>
              <input type="tel"
                     id="phone"
                     name="phone"
                     th:value="${userDetails != null ? userDetails.phone : ''}"
                     required
                     pattern="\+?\d{10,13}"
                     maxlength="10"
                     title="Введіть коректний номер телефону">
            </div>

            <div class="form-group">
              <label for="email">E-mail:</label>
              <input type="email"
                     id="email"
                     name="email"
                     th:value="${userDetails != null ? userDetails.email : ''}"
                     required>
            </div>
          </div>

          <!-- Адреса доставки -->
          <div class="form-section">
            <h2>Адреса доставки</h2>

            <!-- Вибір джерела адреси -->
            <div class="address-radio-group">
              <div>
                <input type="radio"
                       id="useProfileAddress"
                       name="addressSource"
                       value="profile"
                       th:checked="${userDetails != null && userDetails.address != null}"
                       onchange="toggleAddressForm(this)">
                <label for="useProfileAddress">Використати адресу з профілю</label>
              </div>

              <div>
                <input type="radio"
                       id="useNewAddress"
                       name="addressSource"
                       value="new"
                       th:checked="${userDetails == null || userDetails.address == null}"
                       onchange="toggleAddressForm(this)">
                <label for="useNewAddress">Вказати нову адресу</label>
              </div>
            </div>

            <!-- Адреса з профілю -->
            <div id="profileAddressSection"
                 th:style="${userDetails != null && userDetails.address != null ? 'display: block' : 'display: none'}"
                 class="profile-address-section">
              <div th:if="${userDetails != null && userDetails.address != null}">
                <p><strong>Регіон:</strong> <span th:text="${userDetails.address.region}"></span></p>
                <p><strong>Місто:</strong> <span th:text="${userDetails.address.city}"></span></p>
                <p><strong>Район:</strong> <span th:text="${userDetails.address.area}"></span></p>
                <p><strong>Вулиця:</strong> <span th:text="${userDetails.address.street}"></span></p>
                <p><strong>Будинок:</strong> <span th:text="${userDetails.address.house}"></span></p>
                <p><strong>Квартира:</strong> <span th:text="${userDetails.address.apartment}"></span></p>
              </div>
            </div>

            <!-- Форма нової адреси -->
            <div id="newAddressSection"
                 th:style="${userDetails == null || userDetails.address == null ? 'display: block' : 'display: none'}"
                 class="new-address-section">
              <div class="address-fields">
                <div class="form-group">
                  <label for="region">Регіон:</label>
                  <input type="text" id="region" name="region">
                </div>

                <div class="form-group">
                  <label for="city">Місто:</label>
                  <input type="text" id="city" name="city">
                </div>

                <div class="form-group">
                  <label for="area">Район:</label>
                  <input type="text" id="area" name="area">
                </div>

                <div class="form-group">
                  <label for="street">Вулиця:</label>
                  <input type="text" id="street" name="street">
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="house">Будинок:</label>
                    <input type="text" id="house" name="house">
                  </div>

                  <div class="form-group">
                    <label for="apartment">Квартира:</label>
                    <input type="text" id="apartment" name="apartment">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Служба доставки -->
          <div class="form-group">
            <label for="postOffice">Служба доставки:</label>
            <select id="postOffice" name="postOffice" required>
              <option value="">Оберіть службу доставки</option>
              <option value="nova_poshta">Нова Пошта</option>
              <option value="ukrposhta">Укрпошта</option>
            </select>
          </div>

          <button type="submit" class="btn-submit">Підтвердити замовлення</button>
        </form>

        <a href="/cart" class="btn-back">Повернутися до кошика</a>
      </div>
    </div>

  </main>
</div>

<footer th:replace="~{fragments/footer :: footer}" class="mt-auto"></footer>

<script>
  function toggleAddressForm(radio) {
    const profileSection = document.getElementById('profileAddressSection');
    const newAddressSection = document.getElementById('newAddressSection');

    if (radio.value === 'profile') {
      profileSection.style.display = 'block';
      newAddressSection.style.display = 'none';
      // Disable new address form inputs
      const inputs = newAddressSection.getElementsByTagName('input');
      for (let input of inputs) {
        input.required = false;
      }
    } else {
      profileSection.style.display = 'none';
      newAddressSection.style.display = 'block';
      // Enable new address form inputs
      const inputs = newAddressSection.getElementsByTagName('input');
      for (let input of inputs) {
        input.required = true;
      }
    }
  }

  // Initialize form on page load
  document.addEventListener('DOMContentLoaded', function () {
    const checkedRadio = document.querySelector('input[name="addressSource"]:checked');
    if (checkedRadio) {
      toggleAddressForm(checkedRadio);
    }
  });
</script>
</body>
</html>
